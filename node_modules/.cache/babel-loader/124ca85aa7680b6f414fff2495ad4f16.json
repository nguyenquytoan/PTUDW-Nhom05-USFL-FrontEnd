{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar Subject_1 = require(\"../../Subject\");\n\nvar Subscriber_1 = require(\"../../Subscriber\");\n\nvar Observable_1 = require(\"../../Observable\");\n\nvar Subscription_1 = require(\"../../Subscription\");\n\nvar ReplaySubject_1 = require(\"../../ReplaySubject\");\n\nvar DEFAULT_WEBSOCKET_CONFIG = {\n  url: '',\n  deserializer: function (e) {\n    return JSON.parse(e.data);\n  },\n  serializer: function (value) {\n    return JSON.stringify(value);\n  }\n};\nvar WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT = 'WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }';\n\nvar WebSocketSubject = function (_super) {\n  __extends(WebSocketSubject, _super);\n\n  function WebSocketSubject(urlConfigOrSource, destination) {\n    var _this = _super.call(this) || this;\n\n    if (urlConfigOrSource instanceof Observable_1.Observable) {\n      _this.destination = destination;\n      _this.source = urlConfigOrSource;\n    } else {\n      var config = _this._config = __assign({}, DEFAULT_WEBSOCKET_CONFIG);\n\n      _this._output = new Subject_1.Subject();\n\n      if (typeof urlConfigOrSource === 'string') {\n        config.url = urlConfigOrSource;\n      } else {\n        for (var key in urlConfigOrSource) {\n          if (urlConfigOrSource.hasOwnProperty(key)) {\n            config[key] = urlConfigOrSource[key];\n          }\n        }\n      }\n\n      if (!config.WebSocketCtor && WebSocket) {\n        config.WebSocketCtor = WebSocket;\n      } else if (!config.WebSocketCtor) {\n        throw new Error('no WebSocket constructor can be found');\n      }\n\n      _this.destination = new ReplaySubject_1.ReplaySubject();\n    }\n\n    return _this;\n  }\n\n  WebSocketSubject.prototype.lift = function (operator) {\n    var sock = new WebSocketSubject(this._config, this.destination);\n    sock.operator = operator;\n    sock.source = this;\n    return sock;\n  };\n\n  WebSocketSubject.prototype._resetState = function () {\n    this._socket = null;\n\n    if (!this.source) {\n      this.destination = new ReplaySubject_1.ReplaySubject();\n    }\n\n    this._output = new Subject_1.Subject();\n  };\n\n  WebSocketSubject.prototype.multiplex = function (subMsg, unsubMsg, messageFilter) {\n    var self = this;\n    return new Observable_1.Observable(function (observer) {\n      try {\n        self.next(subMsg());\n      } catch (err) {\n        observer.error(err);\n      }\n\n      var subscription = self.subscribe(function (x) {\n        try {\n          if (messageFilter(x)) {\n            observer.next(x);\n          }\n        } catch (err) {\n          observer.error(err);\n        }\n      }, function (err) {\n        return observer.error(err);\n      }, function () {\n        return observer.complete();\n      });\n      return function () {\n        try {\n          self.next(unsubMsg());\n        } catch (err) {\n          observer.error(err);\n        }\n\n        subscription.unsubscribe();\n      };\n    });\n  };\n\n  WebSocketSubject.prototype._connectSocket = function () {\n    var _this = this;\n\n    var _a = this._config,\n        WebSocketCtor = _a.WebSocketCtor,\n        protocol = _a.protocol,\n        url = _a.url,\n        binaryType = _a.binaryType;\n    var observer = this._output;\n    var socket = null;\n\n    try {\n      socket = protocol ? new WebSocketCtor(url, protocol) : new WebSocketCtor(url);\n      this._socket = socket;\n\n      if (binaryType) {\n        this._socket.binaryType = binaryType;\n      }\n    } catch (e) {\n      observer.error(e);\n      return;\n    }\n\n    var subscription = new Subscription_1.Subscription(function () {\n      _this._socket = null;\n\n      if (socket && socket.readyState === 1) {\n        socket.close();\n      }\n    });\n\n    socket.onopen = function (e) {\n      var _socket = _this._socket;\n\n      if (!_socket) {\n        socket.close();\n\n        _this._resetState();\n\n        return;\n      }\n\n      var openObserver = _this._config.openObserver;\n\n      if (openObserver) {\n        openObserver.next(e);\n      }\n\n      var queue = _this.destination;\n      _this.destination = Subscriber_1.Subscriber.create(function (x) {\n        if (socket.readyState === 1) {\n          try {\n            var serializer = _this._config.serializer;\n            socket.send(serializer(x));\n          } catch (e) {\n            _this.destination.error(e);\n          }\n        }\n      }, function (e) {\n        var closingObserver = _this._config.closingObserver;\n\n        if (closingObserver) {\n          closingObserver.next(undefined);\n        }\n\n        if (e && e.code) {\n          socket.close(e.code, e.reason);\n        } else {\n          observer.error(new TypeError(WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT));\n        }\n\n        _this._resetState();\n      }, function () {\n        var closingObserver = _this._config.closingObserver;\n\n        if (closingObserver) {\n          closingObserver.next(undefined);\n        }\n\n        socket.close();\n\n        _this._resetState();\n      });\n\n      if (queue && queue instanceof ReplaySubject_1.ReplaySubject) {\n        subscription.add(queue.subscribe(_this.destination));\n      }\n    };\n\n    socket.onerror = function (e) {\n      _this._resetState();\n\n      observer.error(e);\n    };\n\n    socket.onclose = function (e) {\n      _this._resetState();\n\n      var closeObserver = _this._config.closeObserver;\n\n      if (closeObserver) {\n        closeObserver.next(e);\n      }\n\n      if (e.wasClean) {\n        observer.complete();\n      } else {\n        observer.error(e);\n      }\n    };\n\n    socket.onmessage = function (e) {\n      try {\n        var deserializer = _this._config.deserializer;\n        observer.next(deserializer(e));\n      } catch (err) {\n        observer.error(err);\n      }\n    };\n  };\n\n  WebSocketSubject.prototype._subscribe = function (subscriber) {\n    var _this = this;\n\n    var source = this.source;\n\n    if (source) {\n      return source.subscribe(subscriber);\n    }\n\n    if (!this._socket) {\n      this._connectSocket();\n    }\n\n    this._output.subscribe(subscriber);\n\n    subscriber.add(function () {\n      var _socket = _this._socket;\n\n      if (_this._output.observers.length === 0) {\n        if (_socket && _socket.readyState === 1) {\n          _socket.close();\n        }\n\n        _this._resetState();\n      }\n    });\n    return subscriber;\n  };\n\n  WebSocketSubject.prototype.unsubscribe = function () {\n    var _socket = this._socket;\n\n    if (_socket && _socket.readyState === 1) {\n      _socket.close();\n    }\n\n    this._resetState();\n\n    _super.prototype.unsubscribe.call(this);\n  };\n\n  return WebSocketSubject;\n}(Subject_1.AnonymousSubject);\n\nexports.WebSocketSubject = WebSocketSubject;","map":{"version":3,"sources":["../../../src/internal/observable/dom/WebSocketSubject.ts"],"names":[],"mappings":"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","sourcesContent":["\"use strict\";\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    }\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __assign = (this && this.__assign) || function () {\n    __assign = Object.assign || function(t) {\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\n            s = arguments[i];\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n                t[p] = s[p];\n        }\n        return t;\n    };\n    return __assign.apply(this, arguments);\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar Subject_1 = require(\"../../Subject\");\nvar Subscriber_1 = require(\"../../Subscriber\");\nvar Observable_1 = require(\"../../Observable\");\nvar Subscription_1 = require(\"../../Subscription\");\nvar ReplaySubject_1 = require(\"../../ReplaySubject\");\nvar DEFAULT_WEBSOCKET_CONFIG = {\n    url: '',\n    deserializer: function (e) { return JSON.parse(e.data); },\n    serializer: function (value) { return JSON.stringify(value); },\n};\nvar WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT = 'WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }';\nvar WebSocketSubject = (function (_super) {\n    __extends(WebSocketSubject, _super);\n    function WebSocketSubject(urlConfigOrSource, destination) {\n        var _this = _super.call(this) || this;\n        if (urlConfigOrSource instanceof Observable_1.Observable) {\n            _this.destination = destination;\n            _this.source = urlConfigOrSource;\n        }\n        else {\n            var config = _this._config = __assign({}, DEFAULT_WEBSOCKET_CONFIG);\n            _this._output = new Subject_1.Subject();\n            if (typeof urlConfigOrSource === 'string') {\n                config.url = urlConfigOrSource;\n            }\n            else {\n                for (var key in urlConfigOrSource) {\n                    if (urlConfigOrSource.hasOwnProperty(key)) {\n                        config[key] = urlConfigOrSource[key];\n                    }\n                }\n            }\n            if (!config.WebSocketCtor && WebSocket) {\n                config.WebSocketCtor = WebSocket;\n            }\n            else if (!config.WebSocketCtor) {\n                throw new Error('no WebSocket constructor can be found');\n            }\n            _this.destination = new ReplaySubject_1.ReplaySubject();\n        }\n        return _this;\n    }\n    WebSocketSubject.prototype.lift = function (operator) {\n        var sock = new WebSocketSubject(this._config, this.destination);\n        sock.operator = operator;\n        sock.source = this;\n        return sock;\n    };\n    WebSocketSubject.prototype._resetState = function () {\n        this._socket = null;\n        if (!this.source) {\n            this.destination = new ReplaySubject_1.ReplaySubject();\n        }\n        this._output = new Subject_1.Subject();\n    };\n    WebSocketSubject.prototype.multiplex = function (subMsg, unsubMsg, messageFilter) {\n        var self = this;\n        return new Observable_1.Observable(function (observer) {\n            try {\n                self.next(subMsg());\n            }\n            catch (err) {\n                observer.error(err);\n            }\n            var subscription = self.subscribe(function (x) {\n                try {\n                    if (messageFilter(x)) {\n                        observer.next(x);\n                    }\n                }\n                catch (err) {\n                    observer.error(err);\n                }\n            }, function (err) { return observer.error(err); }, function () { return observer.complete(); });\n            return function () {\n                try {\n                    self.next(unsubMsg());\n                }\n                catch (err) {\n                    observer.error(err);\n                }\n                subscription.unsubscribe();\n            };\n        });\n    };\n    WebSocketSubject.prototype._connectSocket = function () {\n        var _this = this;\n        var _a = this._config, WebSocketCtor = _a.WebSocketCtor, protocol = _a.protocol, url = _a.url, binaryType = _a.binaryType;\n        var observer = this._output;\n        var socket = null;\n        try {\n            socket = protocol ?\n                new WebSocketCtor(url, protocol) :\n                new WebSocketCtor(url);\n            this._socket = socket;\n            if (binaryType) {\n                this._socket.binaryType = binaryType;\n            }\n        }\n        catch (e) {\n            observer.error(e);\n            return;\n        }\n        var subscription = new Subscription_1.Subscription(function () {\n            _this._socket = null;\n            if (socket && socket.readyState === 1) {\n                socket.close();\n            }\n        });\n        socket.onopen = function (e) {\n            var _socket = _this._socket;\n            if (!_socket) {\n                socket.close();\n                _this._resetState();\n                return;\n            }\n            var openObserver = _this._config.openObserver;\n            if (openObserver) {\n                openObserver.next(e);\n            }\n            var queue = _this.destination;\n            _this.destination = Subscriber_1.Subscriber.create(function (x) {\n                if (socket.readyState === 1) {\n                    try {\n                        var serializer = _this._config.serializer;\n                        socket.send(serializer(x));\n                    }\n                    catch (e) {\n                        _this.destination.error(e);\n                    }\n                }\n            }, function (e) {\n                var closingObserver = _this._config.closingObserver;\n                if (closingObserver) {\n                    closingObserver.next(undefined);\n                }\n                if (e && e.code) {\n                    socket.close(e.code, e.reason);\n                }\n                else {\n                    observer.error(new TypeError(WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT));\n                }\n                _this._resetState();\n            }, function () {\n                var closingObserver = _this._config.closingObserver;\n                if (closingObserver) {\n                    closingObserver.next(undefined);\n                }\n                socket.close();\n                _this._resetState();\n            });\n            if (queue && queue instanceof ReplaySubject_1.ReplaySubject) {\n                subscription.add(queue.subscribe(_this.destination));\n            }\n        };\n        socket.onerror = function (e) {\n            _this._resetState();\n            observer.error(e);\n        };\n        socket.onclose = function (e) {\n            _this._resetState();\n            var closeObserver = _this._config.closeObserver;\n            if (closeObserver) {\n                closeObserver.next(e);\n            }\n            if (e.wasClean) {\n                observer.complete();\n            }\n            else {\n                observer.error(e);\n            }\n        };\n        socket.onmessage = function (e) {\n            try {\n                var deserializer = _this._config.deserializer;\n                observer.next(deserializer(e));\n            }\n            catch (err) {\n                observer.error(err);\n            }\n        };\n    };\n    WebSocketSubject.prototype._subscribe = function (subscriber) {\n        var _this = this;\n        var source = this.source;\n        if (source) {\n            return source.subscribe(subscriber);\n        }\n        if (!this._socket) {\n            this._connectSocket();\n        }\n        this._output.subscribe(subscriber);\n        subscriber.add(function () {\n            var _socket = _this._socket;\n            if (_this._output.observers.length === 0) {\n                if (_socket && _socket.readyState === 1) {\n                    _socket.close();\n                }\n                _this._resetState();\n            }\n        });\n        return subscriber;\n    };\n    WebSocketSubject.prototype.unsubscribe = function () {\n        var _socket = this._socket;\n        if (_socket && _socket.readyState === 1) {\n            _socket.close();\n        }\n        this._resetState();\n        _super.prototype.unsubscribe.call(this);\n    };\n    return WebSocketSubject;\n}(Subject_1.AnonymousSubject));\nexports.WebSocketSubject = WebSocketSubject;\n//# sourceMappingURL=WebSocketSubject.js.map"]},"metadata":{},"sourceType":"script"}