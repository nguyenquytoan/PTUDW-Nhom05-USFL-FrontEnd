{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, '__esModule', {\n  value: true\n});\nexports.default = void 0;\n\nfunction path() {\n  const data = _interopRequireWildcard(require('path'));\n\n  path = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _stream() {\n  const data = require('stream');\n\n  _stream = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _worker_threads() {\n  const data = require('worker_threads');\n\n  _worker_threads = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _mergeStream() {\n  const data = _interopRequireDefault(require('merge-stream'));\n\n  _mergeStream = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _types() {\n  const data = require('../types');\n\n  _types = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction _getRequireWildcardCache() {\n  if (typeof WeakMap !== 'function') return null;\n  var cache = new WeakMap();\n\n  _getRequireWildcardCache = function () {\n    return cache;\n  };\n\n  return cache;\n}\n\nfunction _interopRequireWildcard(obj) {\n  if (obj && obj.__esModule) {\n    return obj;\n  }\n\n  if (obj === null || typeof obj !== 'object' && typeof obj !== 'function') {\n    return {\n      default: obj\n    };\n  }\n\n  var cache = _getRequireWildcardCache();\n\n  if (cache && cache.has(obj)) {\n    return cache.get(obj);\n  }\n\n  var newObj = {};\n  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;\n\n  for (var key in obj) {\n    if (Object.prototype.hasOwnProperty.call(obj, key)) {\n      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;\n\n      if (desc && (desc.get || desc.set)) {\n        Object.defineProperty(newObj, key, desc);\n      } else {\n        newObj[key] = obj[key];\n      }\n    }\n  }\n\n  newObj.default = obj;\n\n  if (cache) {\n    cache.set(obj, newObj);\n  }\n\n  return newObj;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nclass ExperimentalWorker {\n  constructor(options) {\n    _defineProperty(this, '_worker', void 0);\n\n    _defineProperty(this, '_options', void 0);\n\n    _defineProperty(this, '_request', void 0);\n\n    _defineProperty(this, '_retries', void 0);\n\n    _defineProperty(this, '_onProcessEnd', void 0);\n\n    _defineProperty(this, '_fakeStream', void 0);\n\n    _defineProperty(this, '_stdout', void 0);\n\n    _defineProperty(this, '_stderr', void 0);\n\n    _defineProperty(this, '_exitPromise', void 0);\n\n    _defineProperty(this, '_resolveExitPromise', void 0);\n\n    _defineProperty(this, '_forceExited', void 0);\n\n    this._options = options;\n    this._request = null;\n    this._fakeStream = null;\n    this._stdout = null;\n    this._stderr = null;\n    this._exitPromise = new Promise(resolve => {\n      this._resolveExitPromise = resolve;\n    });\n    this._forceExited = false;\n    this.initialize();\n  }\n\n  initialize() {\n    this._worker = new (_worker_threads().Worker)(path().resolve(__dirname, './threadChild.js'), {\n      eval: false,\n      stderr: true,\n      stdout: true,\n      workerData: {\n        cwd: process.cwd(),\n        env: { ...process.env,\n          JEST_WORKER_ID: String(this._options.workerId + 1) // 0-indexed workerId, 1-indexed JEST_WORKER_ID\n\n        },\n        // Suppress --debug / --inspect flags while preserving others (like --harmony).\n        execArgv: process.execArgv.filter(v => !/^--(debug|inspect)/.test(v)),\n        silent: true,\n        ...this._options.forkOptions\n      }\n    });\n\n    if (this._worker.stdout) {\n      if (!this._stdout) {\n        // We need to add a permanent stream to the merged stream to prevent it\n        // from ending when the subprocess stream ends\n        this._stdout = (0, _mergeStream().default)(this._getFakeStream());\n      }\n\n      this._stdout.add(this._worker.stdout);\n    }\n\n    if (this._worker.stderr) {\n      if (!this._stderr) {\n        // We need to add a permanent stream to the merged stream to prevent it\n        // from ending when the subprocess stream ends\n        this._stderr = (0, _mergeStream().default)(this._getFakeStream());\n      }\n\n      this._stderr.add(this._worker.stderr);\n    }\n\n    this._worker.on('message', this._onMessage.bind(this));\n\n    this._worker.on('exit', this._onExit.bind(this));\n\n    this._worker.postMessage([_types().CHILD_MESSAGE_INITIALIZE, false, this._options.workerPath, this._options.setupArgs]);\n\n    this._retries++; // If we exceeded the amount of retries, we will emulate an error reply\n    // coming from the child. This avoids code duplication related with cleaning\n    // the queue, and scheduling the next call.\n\n    if (this._retries > this._options.maxRetries) {\n      const error = new Error('Call retries were exceeded');\n\n      this._onMessage([_types().PARENT_MESSAGE_CLIENT_ERROR, error.name, error.message, error.stack, {\n        type: 'WorkerError'\n      }]);\n    }\n  }\n\n  _shutdown() {\n    // End the permanent stream so the merged stream end too\n    if (this._fakeStream) {\n      this._fakeStream.end();\n\n      this._fakeStream = null;\n    }\n\n    this._resolveExitPromise();\n  }\n\n  _onMessage(response) {\n    let error;\n\n    switch (response[0]) {\n      case _types().PARENT_MESSAGE_OK:\n        this._onProcessEnd(null, response[1]);\n\n        break;\n\n      case _types().PARENT_MESSAGE_CLIENT_ERROR:\n        error = response[4];\n\n        if (error != null && typeof error === 'object') {\n          const extra = error; // @ts-ignore: no index\n\n          const NativeCtor = global[response[1]];\n          const Ctor = typeof NativeCtor === 'function' ? NativeCtor : Error;\n          error = new Ctor(response[2]);\n          error.type = response[1];\n          error.stack = response[3];\n\n          for (const key in extra) {\n            // @ts-ignore: no index\n            error[key] = extra[key];\n          }\n        }\n\n        this._onProcessEnd(error, null);\n\n        break;\n\n      case _types().PARENT_MESSAGE_SETUP_ERROR:\n        error = new Error('Error when calling setup: ' + response[2]); // @ts-ignore: adding custom properties to errors.\n\n        error.type = response[1];\n        error.stack = response[3];\n\n        this._onProcessEnd(error, null);\n\n        break;\n\n      default:\n        throw new TypeError('Unexpected response from worker: ' + response[0]);\n    }\n  }\n\n  _onExit(exitCode) {\n    if (exitCode !== 0 && !this._forceExited) {\n      this.initialize();\n\n      if (this._request) {\n        this._worker.postMessage(this._request);\n      }\n    } else {\n      this._shutdown();\n    }\n  }\n\n  waitForExit() {\n    return this._exitPromise;\n  }\n\n  forceExit() {\n    this._forceExited = true;\n\n    this._worker.terminate();\n  }\n\n  send(request, onProcessStart, onProcessEnd) {\n    onProcessStart(this);\n\n    this._onProcessEnd = (...args) => {\n      // Clean the request to avoid sending past requests to workers that fail\n      // while waiting for a new request (timers, unhandled rejections...)\n      this._request = null;\n      return onProcessEnd(...args);\n    };\n\n    this._request = request;\n    this._retries = 0;\n\n    this._worker.postMessage(request);\n  }\n\n  getWorkerId() {\n    return this._options.workerId;\n  }\n\n  getStdout() {\n    return this._stdout;\n  }\n\n  getStderr() {\n    return this._stderr;\n  }\n\n  _getFakeStream() {\n    if (!this._fakeStream) {\n      this._fakeStream = new (_stream().PassThrough)();\n    }\n\n    return this._fakeStream;\n  }\n\n}\n\nexports.default = ExperimentalWorker;","map":{"version":3,"sources":["/Users/nguyenquytoan/Desktop/PTUDW-17TN-Nhom05-USFL/react-usfl/PTUDW-17TN-Nhom05/node_modules/terser-webpack-plugin/node_modules/jest-worker/build/workers/NodeThreadsWorker.js"],"names":["Object","defineProperty","exports","value","default","path","data","_interopRequireWildcard","require","_stream","_worker_threads","_mergeStream","_interopRequireDefault","_types","obj","__esModule","_getRequireWildcardCache","WeakMap","cache","has","get","newObj","hasPropertyDescriptor","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_defineProperty","enumerable","configurable","writable","ExperimentalWorker","constructor","options","_options","_request","_fakeStream","_stdout","_stderr","_exitPromise","Promise","resolve","_resolveExitPromise","_forceExited","initialize","_worker","Worker","__dirname","eval","stderr","stdout","workerData","cwd","process","env","JEST_WORKER_ID","String","workerId","execArgv","filter","v","test","silent","forkOptions","_getFakeStream","add","on","_onMessage","bind","_onExit","postMessage","CHILD_MESSAGE_INITIALIZE","workerPath","setupArgs","_retries","maxRetries","error","Error","PARENT_MESSAGE_CLIENT_ERROR","name","message","stack","type","_shutdown","end","response","PARENT_MESSAGE_OK","_onProcessEnd","extra","NativeCtor","global","Ctor","PARENT_MESSAGE_SETUP_ERROR","TypeError","exitCode","waitForExit","forceExit","terminate","send","request","onProcessStart","onProcessEnd","args","getWorkerId","getStdout","getStderr","PassThrough"],"mappings":"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","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, '__esModule', {\n  value: true\n});\nexports.default = void 0;\n\nfunction path() {\n  const data = _interopRequireWildcard(require('path'));\n\n  path = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _stream() {\n  const data = require('stream');\n\n  _stream = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _worker_threads() {\n  const data = require('worker_threads');\n\n  _worker_threads = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _mergeStream() {\n  const data = _interopRequireDefault(require('merge-stream'));\n\n  _mergeStream = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _types() {\n  const data = require('../types');\n\n  _types = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {default: obj};\n}\n\nfunction _getRequireWildcardCache() {\n  if (typeof WeakMap !== 'function') return null;\n  var cache = new WeakMap();\n  _getRequireWildcardCache = function () {\n    return cache;\n  };\n  return cache;\n}\n\nfunction _interopRequireWildcard(obj) {\n  if (obj && obj.__esModule) {\n    return obj;\n  }\n  if (obj === null || (typeof obj !== 'object' && typeof obj !== 'function')) {\n    return {default: obj};\n  }\n  var cache = _getRequireWildcardCache();\n  if (cache && cache.has(obj)) {\n    return cache.get(obj);\n  }\n  var newObj = {};\n  var hasPropertyDescriptor =\n    Object.defineProperty && Object.getOwnPropertyDescriptor;\n  for (var key in obj) {\n    if (Object.prototype.hasOwnProperty.call(obj, key)) {\n      var desc = hasPropertyDescriptor\n        ? Object.getOwnPropertyDescriptor(obj, key)\n        : null;\n      if (desc && (desc.get || desc.set)) {\n        Object.defineProperty(newObj, key, desc);\n      } else {\n        newObj[key] = obj[key];\n      }\n    }\n  }\n  newObj.default = obj;\n  if (cache) {\n    cache.set(obj, newObj);\n  }\n  return newObj;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n  return obj;\n}\n\nclass ExperimentalWorker {\n  constructor(options) {\n    _defineProperty(this, '_worker', void 0);\n\n    _defineProperty(this, '_options', void 0);\n\n    _defineProperty(this, '_request', void 0);\n\n    _defineProperty(this, '_retries', void 0);\n\n    _defineProperty(this, '_onProcessEnd', void 0);\n\n    _defineProperty(this, '_fakeStream', void 0);\n\n    _defineProperty(this, '_stdout', void 0);\n\n    _defineProperty(this, '_stderr', void 0);\n\n    _defineProperty(this, '_exitPromise', void 0);\n\n    _defineProperty(this, '_resolveExitPromise', void 0);\n\n    _defineProperty(this, '_forceExited', void 0);\n\n    this._options = options;\n    this._request = null;\n    this._fakeStream = null;\n    this._stdout = null;\n    this._stderr = null;\n    this._exitPromise = new Promise(resolve => {\n      this._resolveExitPromise = resolve;\n    });\n    this._forceExited = false;\n    this.initialize();\n  }\n\n  initialize() {\n    this._worker = new (_worker_threads().Worker)(\n      path().resolve(__dirname, './threadChild.js'),\n      {\n        eval: false,\n        stderr: true,\n        stdout: true,\n        workerData: {\n          cwd: process.cwd(),\n          env: {\n            ...process.env,\n            JEST_WORKER_ID: String(this._options.workerId + 1) // 0-indexed workerId, 1-indexed JEST_WORKER_ID\n          },\n          // Suppress --debug / --inspect flags while preserving others (like --harmony).\n          execArgv: process.execArgv.filter(v => !/^--(debug|inspect)/.test(v)),\n          silent: true,\n          ...this._options.forkOptions\n        }\n      }\n    );\n\n    if (this._worker.stdout) {\n      if (!this._stdout) {\n        // We need to add a permanent stream to the merged stream to prevent it\n        // from ending when the subprocess stream ends\n        this._stdout = (0, _mergeStream().default)(this._getFakeStream());\n      }\n\n      this._stdout.add(this._worker.stdout);\n    }\n\n    if (this._worker.stderr) {\n      if (!this._stderr) {\n        // We need to add a permanent stream to the merged stream to prevent it\n        // from ending when the subprocess stream ends\n        this._stderr = (0, _mergeStream().default)(this._getFakeStream());\n      }\n\n      this._stderr.add(this._worker.stderr);\n    }\n\n    this._worker.on('message', this._onMessage.bind(this));\n\n    this._worker.on('exit', this._onExit.bind(this));\n\n    this._worker.postMessage([\n      _types().CHILD_MESSAGE_INITIALIZE,\n      false,\n      this._options.workerPath,\n      this._options.setupArgs\n    ]);\n\n    this._retries++; // If we exceeded the amount of retries, we will emulate an error reply\n    // coming from the child. This avoids code duplication related with cleaning\n    // the queue, and scheduling the next call.\n\n    if (this._retries > this._options.maxRetries) {\n      const error = new Error('Call retries were exceeded');\n\n      this._onMessage([\n        _types().PARENT_MESSAGE_CLIENT_ERROR,\n        error.name,\n        error.message,\n        error.stack,\n        {\n          type: 'WorkerError'\n        }\n      ]);\n    }\n  }\n\n  _shutdown() {\n    // End the permanent stream so the merged stream end too\n    if (this._fakeStream) {\n      this._fakeStream.end();\n\n      this._fakeStream = null;\n    }\n\n    this._resolveExitPromise();\n  }\n\n  _onMessage(response) {\n    let error;\n\n    switch (response[0]) {\n      case _types().PARENT_MESSAGE_OK:\n        this._onProcessEnd(null, response[1]);\n\n        break;\n\n      case _types().PARENT_MESSAGE_CLIENT_ERROR:\n        error = response[4];\n\n        if (error != null && typeof error === 'object') {\n          const extra = error; // @ts-ignore: no index\n\n          const NativeCtor = global[response[1]];\n          const Ctor = typeof NativeCtor === 'function' ? NativeCtor : Error;\n          error = new Ctor(response[2]);\n          error.type = response[1];\n          error.stack = response[3];\n\n          for (const key in extra) {\n            // @ts-ignore: no index\n            error[key] = extra[key];\n          }\n        }\n\n        this._onProcessEnd(error, null);\n\n        break;\n\n      case _types().PARENT_MESSAGE_SETUP_ERROR:\n        error = new Error('Error when calling setup: ' + response[2]); // @ts-ignore: adding custom properties to errors.\n\n        error.type = response[1];\n        error.stack = response[3];\n\n        this._onProcessEnd(error, null);\n\n        break;\n\n      default:\n        throw new TypeError('Unexpected response from worker: ' + response[0]);\n    }\n  }\n\n  _onExit(exitCode) {\n    if (exitCode !== 0 && !this._forceExited) {\n      this.initialize();\n\n      if (this._request) {\n        this._worker.postMessage(this._request);\n      }\n    } else {\n      this._shutdown();\n    }\n  }\n\n  waitForExit() {\n    return this._exitPromise;\n  }\n\n  forceExit() {\n    this._forceExited = true;\n\n    this._worker.terminate();\n  }\n\n  send(request, onProcessStart, onProcessEnd) {\n    onProcessStart(this);\n\n    this._onProcessEnd = (...args) => {\n      // Clean the request to avoid sending past requests to workers that fail\n      // while waiting for a new request (timers, unhandled rejections...)\n      this._request = null;\n      return onProcessEnd(...args);\n    };\n\n    this._request = request;\n    this._retries = 0;\n\n    this._worker.postMessage(request);\n  }\n\n  getWorkerId() {\n    return this._options.workerId;\n  }\n\n  getStdout() {\n    return this._stdout;\n  }\n\n  getStderr() {\n    return this._stderr;\n  }\n\n  _getFakeStream() {\n    if (!this._fakeStream) {\n      this._fakeStream = new (_stream().PassThrough)();\n    }\n\n    return this._fakeStream;\n  }\n}\n\nexports.default = ExperimentalWorker;\n"]},"metadata":{},"sourceType":"script"}