{"ast":null,"code":"/* eslint-disable class-methods-use-this */\n'use strict';\n\nconst UTIL = require('util'),\n      PATH = require('path'),\n      EOL = require('os').EOL,\n      Q = require('q'),\n      chalk = require('chalk'),\n      CoaObject = require('./coaobject'),\n      Opt = require('./opt'),\n      Arg = require('./arg'),\n      completion = require('./completion');\n/**\n * Command\n *\n * Top level entity. Commands may have options and arguments.\n *\n * @namespace\n * @class Cmd\n * @extends CoaObject\n */\n\n\nclass Cmd extends CoaObject {\n  /**\n   * @constructs\n   * @param {COA.Cmd} [cmd] parent command\n   */\n  constructor(cmd) {\n    super(cmd);\n\n    this._parent(cmd);\n\n    this._cmds = [];\n    this._cmdsByName = {};\n    this._opts = [];\n    this._optsByKey = {};\n    this._args = [];\n    this._api = null;\n    this._ext = false;\n  }\n\n  static create(cmd) {\n    return new Cmd(cmd);\n  }\n  /**\n   * Returns object containing all its subcommands as methods\n   * to use from other programs.\n   *\n   * @returns {Object}\n   */\n\n\n  get api() {\n    // Need _this here because of passed arguments into _api\n    const _this = this;\n\n    this._api || (this._api = function () {\n      return _this.invoke.apply(_this, arguments);\n    });\n    const cmds = this._cmdsByName;\n    Object.keys(cmds).forEach(cmd => {\n      this._api[cmd] = cmds[cmd].api;\n    });\n    return this._api;\n  }\n\n  _parent(cmd) {\n    this._cmd = cmd || this;\n    this.isRootCmd || cmd._cmds.push(this) && this._name && (this._cmd._cmdsByName[this._name] = this);\n    return this;\n  }\n\n  get isRootCmd() {\n    return this._cmd === this;\n  }\n  /**\n   * Set a canonical command identifier to be used anywhere in the API.\n   *\n   * @param {String} name - command name\n   * @returns {COA.Cmd} - this instance (for chainability)\n   */\n\n\n  name(name) {\n    super.name(name);\n    this.isRootCmd || (this._cmd._cmdsByName[name] = this);\n    return this;\n  }\n  /**\n   * Create new or add existing subcommand for current command.\n   *\n   * @param {COA.Cmd} [cmd] existing command instance\n   * @returns {COA.Cmd} new subcommand instance\n   */\n\n\n  cmd(cmd) {\n    return cmd ? cmd._parent(this) : new Cmd(this);\n  }\n  /**\n   * Create option for current command.\n   *\n   * @returns {COA.Opt} new option instance\n   */\n\n\n  opt() {\n    return new Opt(this);\n  }\n  /**\n   * Create argument for current command.\n   *\n   * @returns {COA.Opt} new argument instance\n   */\n\n\n  arg() {\n    return new Arg(this);\n  }\n  /**\n   * Add (or set) action for current command.\n   *\n   * @param {Function} act - action function,\n   *         invoked in the context of command instance\n   *         and has the parameters:\n   *                 - {Object} opts - parsed options\n   *                 - {String[]} args - parsed arguments\n   *                 - {Object} res - actions result accumulator\n   *         It can return rejected promise by Cmd.reject (in case of error)\n   *         or any other value treated as result.\n   * @param {Boolean} [force=false] flag for set action instead add to existings\n   * @returns {COA.Cmd} - this instance (for chainability)\n   */\n\n\n  act(act, force) {\n    if (!act) return this;\n    (!this._act || force) && (this._act = []);\n\n    this._act.push(act);\n\n    return this;\n  }\n  /**\n   * Make command \"helpful\", i.e. add -h --help flags for print usage.\n   *\n   * @returns {COA.Cmd} - this instance (for chainability)\n   */\n\n\n  helpful() {\n    return this.opt().name('help').title('Help').short('h').long('help').flag().only().act(function () {\n      return this.usage();\n    }).end();\n  }\n  /**\n   * Adds shell completion to command, adds \"completion\" subcommand,\n   * that makes all the magic.\n   * Must be called only on root command.\n   *\n   * @returns {COA.Cmd} - this instance (for chainability)\n   */\n\n\n  completable() {\n    return this.cmd().name('completion').apply(completion).end();\n  }\n  /**\n   * Allow command to be extendable by external node.js modules.\n   *\n   * @param {String} [pattern]  Pattern of node.js module to find subcommands at.\n   * @returns {COA.Cmd} - this instance (for chainability)\n   */\n\n\n  extendable(pattern) {\n    this._ext = pattern || true;\n    return this;\n  }\n\n  _exit(msg, code) {\n    return process.once('exit', function (exitCode) {\n      msg && console[code === 0 ? 'log' : 'error'](msg);\n      process.exit(code || exitCode || 0);\n    });\n  }\n  /**\n   * Build full usage text for current command instance.\n   *\n   * @returns {String} usage text\n   */\n\n\n  usage() {\n    const res = [];\n    this._title && res.push(this._fullTitle());\n    res.push('', 'Usage:');\n    this._cmds.length && res.push(['', '', chalk.redBright(this._fullName()), chalk.blueBright('COMMAND'), chalk.greenBright('[OPTIONS]'), chalk.magentaBright('[ARGS]')].join(' '));\n    this._opts.length + this._args.length && res.push(['', '', chalk.redBright(this._fullName()), chalk.greenBright('[OPTIONS]'), chalk.magentaBright('[ARGS]')].join(' '));\n    res.push(this._usages(this._cmds, 'Commands'), this._usages(this._opts, 'Options'), this._usages(this._args, 'Arguments'));\n    return res.join(EOL);\n  }\n\n  _usage() {\n    return chalk.blueBright(this._name) + ' : ' + this._title;\n  }\n\n  _usages(os, title) {\n    if (!os.length) return;\n    return ['', title + ':'].concat(os.map(o => `  ${o._usage()}`)).join(EOL);\n  }\n\n  _fullTitle() {\n    return `${this.isRootCmd ? '' : this._cmd._fullTitle() + EOL}${this._title}`;\n  }\n\n  _fullName() {\n    return `${this.isRootCmd ? '' : this._cmd._fullName() + ' '}${PATH.basename(this._name)}`;\n  }\n\n  _ejectOpt(opts, opt) {\n    const pos = opts.indexOf(opt);\n    if (pos === -1) return;\n    return opts[pos]._arr ? opts[pos] : opts.splice(pos, 1)[0];\n  }\n\n  _checkRequired(opts, args) {\n    if (this._opts.some(opt => opt._only && opts.hasOwnProperty(opt._name))) return;\n\n    const all = this._opts.concat(this._args);\n\n    let i;\n\n    while (i = all.shift()) if (i._req && i._checkParsed(opts, args)) return this.reject(i._requiredText());\n  }\n\n  _parseCmd(argv, unparsed) {\n    unparsed || (unparsed = []);\n    let i,\n        optSeen = false;\n\n    while (i = argv.shift()) {\n      i.indexOf('-') || (optSeen = true);\n\n      if (optSeen || !/^\\w[\\w-_]*$/.test(i)) {\n        unparsed.push(i);\n        continue;\n      }\n\n      let pkg,\n          cmd = this._cmdsByName[i];\n\n      if (!cmd && this._ext) {\n        if (this._ext === true) {\n          pkg = i;\n          let c = this;\n\n          while (true) {\n            // eslint-disable-line\n            pkg = c._name + '-' + pkg;\n            if (c.isRootCmd) break;\n            c = c._cmd;\n          }\n        } else if (typeof this._ext === 'string') pkg = ~this._ext.indexOf('%s') ? UTIL.format(this._ext, i) : this._ext + i;\n\n        let cmdDesc;\n\n        try {\n          cmdDesc = require(pkg);\n        } catch (e) {// Dummy\n        }\n\n        if (cmdDesc) {\n          if (typeof cmdDesc === 'function') {\n            this.cmd().name(i).apply(cmdDesc).end();\n          } else if (typeof cmdDesc === 'object') {\n            this.cmd(cmdDesc);\n            cmdDesc.name(i);\n          } else throw new Error('Error: Unsupported command declaration type, ' + 'should be a function or COA.Cmd() object');\n\n          cmd = this._cmdsByName[i];\n        }\n      }\n\n      if (cmd) return cmd._parseCmd(argv, unparsed);\n      unparsed.push(i);\n    }\n\n    return {\n      cmd: this,\n      argv: unparsed\n    };\n  }\n\n  _parseOptsAndArgs(argv) {\n    const opts = {},\n          args = {},\n          nonParsedOpts = this._opts.concat(),\n          nonParsedArgs = this._args.concat();\n\n    let res, i;\n\n    while (i = argv.shift()) {\n      if (i !== '--' && i[0] === '-') {\n        const m = i.match(/^(--\\w[\\w-_]*)=(.*)$/);\n\n        if (m) {\n          i = m[1];\n          this._optsByKey[i]._flag || argv.unshift(m[2]);\n        }\n\n        const opt = this._ejectOpt(nonParsedOpts, this._optsByKey[i]);\n\n        if (!opt) return this.reject(`Unknown option: ${i}`);\n        if (Q.isRejected(res = opt._parse(argv, opts))) return res;\n        continue;\n      }\n\n      i === '--' && (i = argv.splice(0));\n      Array.isArray(i) || (i = [i]);\n      let a;\n\n      while (a = i.shift()) {\n        let arg = nonParsedArgs.shift();\n        if (!arg) return this.reject(`Unknown argument: ${a}`);\n        arg._arr && nonParsedArgs.unshift(arg);\n        if (Q.isRejected(res = arg._parse(a, args))) return res;\n      }\n    }\n\n    return {\n      opts: this._setDefaults(opts, nonParsedOpts),\n      args: this._setDefaults(args, nonParsedArgs)\n    };\n  }\n\n  _setDefaults(params, desc) {\n    for (const item of desc) item._def !== undefined && !params.hasOwnProperty(item._name) && item._saveVal(params, item._def);\n\n    return params;\n  }\n\n  _processParams(params, desc) {\n    const notExists = [];\n\n    for (const item of desc) {\n      const n = item._name;\n\n      if (!params.hasOwnProperty(n)) {\n        notExists.push(item);\n        continue;\n      }\n\n      const vals = Array.isArray(params[n]) ? params[n] : [params[n]];\n      delete params[n];\n      let res;\n\n      for (const v of vals) if (Q.isRejected(res = item._saveVal(params, v))) return res;\n    }\n\n    return this._setDefaults(params, notExists);\n  }\n\n  _parseArr(argv) {\n    return Q.when(this._parseCmd(argv), p => Q.when(p.cmd._parseOptsAndArgs(p.argv), r => ({\n      cmd: p.cmd,\n      opts: r.opts,\n      args: r.args\n    })));\n  }\n\n  _do(inputPromise) {\n    return Q.when(inputPromise, input => {\n      return [this._checkRequired].concat(input.cmd._act || []).reduce((res, act) => Q.when(res, prev => act.call(input.cmd, input.opts, input.args, prev)), undefined);\n    });\n  }\n  /**\n   * Parse arguments from simple format like NodeJS process.argv\n   * and run ahead current program, i.e. call process.exit when all actions done.\n   *\n   * @param {String[]} argv - arguments\n   * @returns {COA.Cmd} - this instance (for chainability)\n   */\n\n\n  run(argv) {\n    argv || (argv = process.argv.slice(2));\n\n    const cb = code => res => res ? this._exit(res.stack || res.toString(), (res.hasOwnProperty('exitCode') ? res.exitCode : code) || 0) : this._exit();\n\n    Q.when(this.do(argv), cb(0), cb(1)).done();\n    return this;\n  }\n  /**\n   * Invoke specified (or current) command using provided\n   * options and arguments.\n   *\n   * @param {String|String[]} [cmds] - subcommand to invoke (optional)\n   * @param {Object} [opts] - command options (optional)\n   * @param {Object} [args] - command arguments (optional)\n   * @returns {Q.Promise}\n   */\n\n\n  invoke(cmds, opts, args) {\n    cmds || (cmds = []);\n    opts || (opts = {});\n    args || (args = {});\n    typeof cmds === 'string' && (cmds = cmds.split(' '));\n\n    if (arguments.length < 3 && !Array.isArray(cmds)) {\n      args = opts;\n      opts = cmds;\n      cmds = [];\n    }\n\n    return Q.when(this._parseCmd(cmds), p => {\n      if (p.argv.length) return this.reject(`Unknown command: ${cmds.join(' ')}`);\n      return Q.all([this._processParams(opts, this._opts), this._processParams(args, this._args)]).spread((_opts, _args) => this._do({\n        cmd: p.cmd,\n        opts: _opts,\n        args: _args\n      }).fail(res => res && res.exitCode === 0 ? res.toString() : this.reject(res)));\n    });\n  }\n\n}\n/**\n * Convenient function to run command from tests.\n *\n * @param {String[]} argv - arguments\n * @returns {Q.Promise}\n */\n\n\nCmd.prototype.do = function (argv) {\n  return this._do(this._parseArr(argv || []));\n};\n\nmodule.exports = Cmd;","map":{"version":3,"sources":["/Users/nguyenquytoan/Desktop/PTUDW-17TN-Nhom05-USFL/react-usfl/PTUDW-17TN-Nhom05/node_modules/coa/lib/cmd.js"],"names":["UTIL","require","PATH","EOL","Q","chalk","CoaObject","Opt","Arg","completion","Cmd","constructor","cmd","_parent","_cmds","_cmdsByName","_opts","_optsByKey","_args","_api","_ext","create","api","_this","invoke","apply","arguments","cmds","Object","keys","forEach","_cmd","isRootCmd","push","_name","name","opt","arg","act","force","_act","helpful","title","short","long","flag","only","usage","end","completable","extendable","pattern","_exit","msg","code","process","once","exitCode","console","exit","res","_title","_fullTitle","length","redBright","_fullName","blueBright","greenBright","magentaBright","join","_usages","_usage","os","concat","map","o","basename","_ejectOpt","opts","pos","indexOf","_arr","splice","_checkRequired","args","some","_only","hasOwnProperty","all","i","shift","_req","_checkParsed","reject","_requiredText","_parseCmd","argv","unparsed","optSeen","test","pkg","c","format","cmdDesc","e","Error","_parseOptsAndArgs","nonParsedOpts","nonParsedArgs","m","match","_flag","unshift","isRejected","_parse","Array","isArray","a","_setDefaults","params","desc","item","_def","undefined","_saveVal","_processParams","notExists","n","vals","v","_parseArr","when","p","r","_do","inputPromise","input","reduce","prev","call","run","slice","cb","stack","toString","do","done","split","spread","fail","prototype","module","exports"],"mappings":"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","sourcesContent":["/* eslint-disable class-methods-use-this */\n'use strict';\n\nconst\n    UTIL = require('util'),\n    PATH = require('path'),\n    EOL = require('os').EOL,\n\n    Q = require('q'),\n    chalk = require('chalk'),\n\n    CoaObject = require('./coaobject'),\n    Opt = require('./opt'),\n    Arg = require('./arg'),\n    completion = require('./completion');\n\n/**\n * Command\n *\n * Top level entity. Commands may have options and arguments.\n *\n * @namespace\n * @class Cmd\n * @extends CoaObject\n */\nclass Cmd extends CoaObject {\n    /**\n     * @constructs\n     * @param {COA.Cmd} [cmd] parent command\n     */\n    constructor(cmd) {\n        super(cmd);\n\n        this._parent(cmd);\n        this._cmds = [];\n        this._cmdsByName = {};\n        this._opts = [];\n        this._optsByKey = {};\n        this._args = [];\n        this._api = null;\n        this._ext = false;\n    }\n\n    static create(cmd) {\n        return new Cmd(cmd);\n    }\n\n    /**\n     * Returns object containing all its subcommands as methods\n     * to use from other programs.\n     *\n     * @returns {Object}\n     */\n    get api() {\n        // Need _this here because of passed arguments into _api\n        const _this = this;\n        this._api || (this._api = function () {\n            return _this.invoke.apply(_this, arguments);\n        });\n\n        const cmds = this._cmdsByName;\n        Object.keys(cmds).forEach(cmd => { this._api[cmd] = cmds[cmd].api; });\n\n        return this._api;\n    }\n\n    _parent(cmd) {\n        this._cmd = cmd || this;\n\n        this.isRootCmd ||\n            cmd._cmds.push(this) &&\n            this._name &&\n            (this._cmd._cmdsByName[this._name] = this);\n\n        return this;\n    }\n\n    get isRootCmd() {\n        return this._cmd === this;\n    }\n\n    /**\n     * Set a canonical command identifier to be used anywhere in the API.\n     *\n     * @param {String} name - command name\n     * @returns {COA.Cmd} - this instance (for chainability)\n     */\n    name(name) {\n        super.name(name);\n\n        this.isRootCmd ||\n            (this._cmd._cmdsByName[name] = this);\n\n        return this;\n    }\n\n    /**\n     * Create new or add existing subcommand for current command.\n     *\n     * @param {COA.Cmd} [cmd] existing command instance\n     * @returns {COA.Cmd} new subcommand instance\n     */\n    cmd(cmd) {\n        return cmd?\n            cmd._parent(this)\n            : new Cmd(this);\n    }\n\n    /**\n     * Create option for current command.\n     *\n     * @returns {COA.Opt} new option instance\n     */\n    opt() {\n        return new Opt(this);\n    }\n\n    /**\n     * Create argument for current command.\n     *\n     * @returns {COA.Opt} new argument instance\n     */\n    arg() {\n        return new Arg(this);\n    }\n\n    /**\n     * Add (or set) action for current command.\n     *\n     * @param {Function} act - action function,\n     *         invoked in the context of command instance\n     *         and has the parameters:\n     *                 - {Object} opts - parsed options\n     *                 - {String[]} args - parsed arguments\n     *                 - {Object} res - actions result accumulator\n     *         It can return rejected promise by Cmd.reject (in case of error)\n     *         or any other value treated as result.\n     * @param {Boolean} [force=false] flag for set action instead add to existings\n     * @returns {COA.Cmd} - this instance (for chainability)\n     */\n    act(act, force) {\n        if(!act) return this;\n\n        (!this._act || force) && (this._act = []);\n        this._act.push(act);\n\n        return this;\n    }\n\n    /**\n     * Make command \"helpful\", i.e. add -h --help flags for print usage.\n     *\n     * @returns {COA.Cmd} - this instance (for chainability)\n     */\n    helpful() {\n        return this.opt()\n            .name('help')\n            .title('Help')\n            .short('h')\n            .long('help')\n            .flag()\n            .only()\n            .act(function() {\n                return this.usage();\n            })\n            .end();\n    }\n\n    /**\n     * Adds shell completion to command, adds \"completion\" subcommand,\n     * that makes all the magic.\n     * Must be called only on root command.\n     *\n     * @returns {COA.Cmd} - this instance (for chainability)\n     */\n    completable() {\n        return this.cmd()\n            .name('completion')\n            .apply(completion)\n            .end();\n    }\n\n    /**\n     * Allow command to be extendable by external node.js modules.\n     *\n     * @param {String} [pattern]  Pattern of node.js module to find subcommands at.\n     * @returns {COA.Cmd} - this instance (for chainability)\n     */\n    extendable(pattern) {\n        this._ext = pattern || true;\n        return this;\n    }\n\n    _exit(msg, code) {\n        return process.once('exit', function(exitCode) {\n            msg && console[code === 0 ? 'log' : 'error'](msg);\n            process.exit(code || exitCode || 0);\n        });\n    }\n\n    /**\n     * Build full usage text for current command instance.\n     *\n     * @returns {String} usage text\n     */\n    usage() {\n        const res = [];\n\n        this._title && res.push(this._fullTitle());\n\n        res.push('', 'Usage:');\n\n        this._cmds.length\n            && res.push([\n                '', '', chalk.redBright(this._fullName()), chalk.blueBright('COMMAND'),\n                chalk.greenBright('[OPTIONS]'), chalk.magentaBright('[ARGS]')\n            ].join(' '));\n\n        (this._opts.length + this._args.length)\n            && res.push([\n                '', '', chalk.redBright(this._fullName()),\n                chalk.greenBright('[OPTIONS]'), chalk.magentaBright('[ARGS]')\n            ].join(' '));\n\n        res.push(\n            this._usages(this._cmds, 'Commands'),\n            this._usages(this._opts, 'Options'),\n            this._usages(this._args, 'Arguments')\n        );\n\n        return res.join(EOL);\n    }\n\n    _usage() {\n        return chalk.blueBright(this._name) + ' : ' + this._title;\n    }\n\n    _usages(os, title) {\n        if(!os.length) return;\n\n        return ['', title + ':']\n            .concat(os.map(o => `  ${o._usage()}`))\n            .join(EOL);\n    }\n\n    _fullTitle() {\n        return `${this.isRootCmd? '' : this._cmd._fullTitle() + EOL}${this._title}`;\n    }\n\n    _fullName() {\n        return `${this.isRootCmd? '' : this._cmd._fullName() + ' '}${PATH.basename(this._name)}`;\n    }\n\n    _ejectOpt(opts, opt) {\n        const pos = opts.indexOf(opt);\n        if(pos === -1) return;\n\n        return opts[pos]._arr?\n            opts[pos] :\n            opts.splice(pos, 1)[0];\n    }\n\n    _checkRequired(opts, args) {\n        if(this._opts.some(opt => opt._only && opts.hasOwnProperty(opt._name))) return;\n\n        const all = this._opts.concat(this._args);\n        let i;\n        while(i = all.shift())\n            if(i._req && i._checkParsed(opts, args))\n                return this.reject(i._requiredText());\n    }\n\n    _parseCmd(argv, unparsed) {\n        unparsed || (unparsed = []);\n\n        let i,\n            optSeen = false;\n        while(i = argv.shift()) {\n            i.indexOf('-') || (optSeen = true);\n\n            if(optSeen || !/^\\w[\\w-_]*$/.test(i)) {\n                unparsed.push(i);\n                continue;\n            }\n\n            let pkg, cmd = this._cmdsByName[i];\n            if(!cmd && this._ext) {\n                if(this._ext === true) {\n                    pkg = i;\n                    let c = this;\n                    while(true) { // eslint-disable-line\n                        pkg = c._name + '-' + pkg;\n                        if(c.isRootCmd) break;\n                        c = c._cmd;\n                    }\n                } else if(typeof this._ext === 'string')\n                    pkg = ~this._ext.indexOf('%s')?\n                        UTIL.format(this._ext, i) :\n                        this._ext + i;\n\n                let cmdDesc;\n                try {\n                    cmdDesc = require(pkg);\n                } catch(e) {\n                    // Dummy\n                }\n\n                if(cmdDesc) {\n                    if(typeof cmdDesc === 'function') {\n                        this.cmd().name(i).apply(cmdDesc).end();\n                    } else if(typeof cmdDesc === 'object') {\n                        this.cmd(cmdDesc);\n                        cmdDesc.name(i);\n                    } else throw new Error('Error: Unsupported command declaration type, '\n                        + 'should be a function or COA.Cmd() object');\n\n                    cmd = this._cmdsByName[i];\n                }\n            }\n\n            if(cmd) return cmd._parseCmd(argv, unparsed);\n\n            unparsed.push(i);\n        }\n\n        return { cmd : this, argv : unparsed };\n    }\n\n    _parseOptsAndArgs(argv) {\n        const opts = {},\n            args = {},\n            nonParsedOpts = this._opts.concat(),\n            nonParsedArgs = this._args.concat();\n\n        let res, i;\n        while(i = argv.shift()) {\n            if(i !== '--' && i[0] === '-') {\n                const m = i.match(/^(--\\w[\\w-_]*)=(.*)$/);\n                if(m) {\n                    i = m[1];\n                    this._optsByKey[i]._flag || argv.unshift(m[2]);\n                }\n\n                const opt = this._ejectOpt(nonParsedOpts, this._optsByKey[i]);\n                if(!opt) return this.reject(`Unknown option: ${i}`);\n\n                if(Q.isRejected(res = opt._parse(argv, opts))) return res;\n\n                continue;\n            }\n\n            i === '--' && (i = argv.splice(0));\n            Array.isArray(i) || (i = [i]);\n\n            let a;\n            while(a = i.shift()) {\n                let arg = nonParsedArgs.shift();\n                if(!arg) return this.reject(`Unknown argument: ${a}`);\n\n                arg._arr && nonParsedArgs.unshift(arg);\n                if(Q.isRejected(res = arg._parse(a, args))) return res;\n            }\n        }\n\n        return {\n            opts : this._setDefaults(opts, nonParsedOpts),\n            args : this._setDefaults(args, nonParsedArgs)\n        };\n    }\n\n    _setDefaults(params, desc) {\n        for(const item of desc)\n            item._def !== undefined &&\n                !params.hasOwnProperty(item._name) &&\n                item._saveVal(params, item._def);\n\n        return params;\n    }\n\n    _processParams(params, desc) {\n        const notExists = [];\n\n        for(const item of desc) {\n            const n = item._name;\n\n            if(!params.hasOwnProperty(n)) {\n                notExists.push(item);\n                continue;\n            }\n\n            const vals = Array.isArray(params[n])? params[n] : [params[n]];\n            delete params[n];\n\n            let res;\n            for(const v of vals)\n                if(Q.isRejected(res = item._saveVal(params, v)))\n                    return res;\n        }\n\n        return this._setDefaults(params, notExists);\n    }\n\n    _parseArr(argv) {\n        return Q.when(this._parseCmd(argv), p =>\n            Q.when(p.cmd._parseOptsAndArgs(p.argv), r => ({\n                cmd : p.cmd,\n                opts : r.opts,\n                args : r.args\n            })));\n    }\n\n    _do(inputPromise) {\n        return Q.when(inputPromise, input => {\n            return [this._checkRequired]\n                .concat(input.cmd._act || [])\n                .reduce((res, act) =>\n                    Q.when(res, prev => act.call(input.cmd, input.opts, input.args, prev)),\n                    undefined);\n        });\n    }\n\n    /**\n     * Parse arguments from simple format like NodeJS process.argv\n     * and run ahead current program, i.e. call process.exit when all actions done.\n     *\n     * @param {String[]} argv - arguments\n     * @returns {COA.Cmd} - this instance (for chainability)\n     */\n    run(argv) {\n        argv || (argv = process.argv.slice(2));\n\n        const cb = code =>\n            res => res?\n                this._exit(res.stack || res.toString(), (res.hasOwnProperty('exitCode')? res.exitCode : code) || 0) :\n                this._exit();\n\n        Q.when(this.do(argv), cb(0), cb(1)).done();\n\n        return this;\n    }\n\n    /**\n     * Invoke specified (or current) command using provided\n     * options and arguments.\n     *\n     * @param {String|String[]} [cmds] - subcommand to invoke (optional)\n     * @param {Object} [opts] - command options (optional)\n     * @param {Object} [args] - command arguments (optional)\n     * @returns {Q.Promise}\n     */\n    invoke(cmds, opts, args) {\n        cmds || (cmds = []);\n        opts || (opts = {});\n        args || (args = {});\n        typeof cmds === 'string' && (cmds = cmds.split(' '));\n\n        if(arguments.length < 3 && !Array.isArray(cmds)) {\n            args = opts;\n            opts = cmds;\n            cmds = [];\n        }\n\n        return Q.when(this._parseCmd(cmds), p => {\n            if(p.argv.length)\n                return this.reject(`Unknown command: ${cmds.join(' ')}`);\n\n            return Q.all([\n                this._processParams(opts, this._opts),\n                this._processParams(args, this._args)\n            ]).spread((_opts, _args) =>\n                this._do({\n                    cmd : p.cmd,\n                    opts : _opts,\n                    args : _args\n                })\n                .fail(res => (res && res.exitCode === 0)?\n                    res.toString() :\n                    this.reject(res)));\n        });\n    }\n}\n\n/**\n * Convenient function to run command from tests.\n *\n * @param {String[]} argv - arguments\n * @returns {Q.Promise}\n */\nCmd.prototype.do = function(argv) {\n    return this._do(this._parseArr(argv || []));\n};\n\nmodule.exports = Cmd;\n"]},"metadata":{},"sourceType":"script"}