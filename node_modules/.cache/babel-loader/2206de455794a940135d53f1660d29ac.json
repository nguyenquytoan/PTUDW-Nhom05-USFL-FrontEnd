{"ast":null,"code":"var canReorderSingle = require('./reorderable').canReorderSingle;\n\nvar extractProperties = require('./extract-properties');\n\nvar isMergeable = require('./is-mergeable');\n\nvar tidyRuleDuplicates = require('./tidy-rule-duplicates');\n\nvar Token = require('../../tokenizer/token');\n\nvar cloneArray = require('../../utils/clone-array');\n\nvar serializeBody = require('../../writer/one-time').body;\n\nvar serializeRules = require('../../writer/one-time').rules;\n\nfunction naturalSorter(a, b) {\n  return a > b ? 1 : -1;\n}\n\nfunction cloneAndMergeSelectors(propertyA, propertyB) {\n  var cloned = cloneArray(propertyA);\n  cloned[5] = cloned[5].concat(propertyB[5]);\n  return cloned;\n}\n\nfunction restructure(tokens, context) {\n  var options = context.options;\n  var mergeablePseudoClasses = options.compatibility.selectors.mergeablePseudoClasses;\n  var mergeablePseudoElements = options.compatibility.selectors.mergeablePseudoElements;\n  var mergeLimit = options.compatibility.selectors.mergeLimit;\n  var multiplePseudoMerging = options.compatibility.selectors.multiplePseudoMerging;\n  var specificityCache = context.cache.specificity;\n  var movableTokens = {};\n  var movedProperties = [];\n  var multiPropertyMoveCache = {};\n  var movedToBeDropped = [];\n  var maxCombinationsLevel = 2;\n  var ID_JOIN_CHARACTER = '%';\n\n  function sendToMultiPropertyMoveCache(position, movedProperty, allFits) {\n    for (var i = allFits.length - 1; i >= 0; i--) {\n      var fit = allFits[i][0];\n      var id = addToCache(movedProperty, fit);\n\n      if (multiPropertyMoveCache[id].length > 1 && processMultiPropertyMove(position, multiPropertyMoveCache[id])) {\n        removeAllMatchingFromCache(id);\n        break;\n      }\n    }\n  }\n\n  function addToCache(movedProperty, fit) {\n    var id = cacheId(fit);\n    multiPropertyMoveCache[id] = multiPropertyMoveCache[id] || [];\n    multiPropertyMoveCache[id].push([movedProperty, fit]);\n    return id;\n  }\n\n  function removeAllMatchingFromCache(matchId) {\n    var matchSelectors = matchId.split(ID_JOIN_CHARACTER);\n    var forRemoval = [];\n    var i;\n\n    for (var id in multiPropertyMoveCache) {\n      var selectors = id.split(ID_JOIN_CHARACTER);\n\n      for (i = selectors.length - 1; i >= 0; i--) {\n        if (matchSelectors.indexOf(selectors[i]) > -1) {\n          forRemoval.push(id);\n          break;\n        }\n      }\n    }\n\n    for (i = forRemoval.length - 1; i >= 0; i--) {\n      delete multiPropertyMoveCache[forRemoval[i]];\n    }\n  }\n\n  function cacheId(cachedTokens) {\n    var id = [];\n\n    for (var i = 0, l = cachedTokens.length; i < l; i++) {\n      id.push(serializeRules(cachedTokens[i][1]));\n    }\n\n    return id.join(ID_JOIN_CHARACTER);\n  }\n\n  function tokensToMerge(sourceTokens) {\n    var uniqueTokensWithBody = [];\n    var mergeableTokens = [];\n\n    for (var i = sourceTokens.length - 1; i >= 0; i--) {\n      if (!isMergeable(serializeRules(sourceTokens[i][1]), mergeablePseudoClasses, mergeablePseudoElements, multiplePseudoMerging)) {\n        continue;\n      }\n\n      mergeableTokens.unshift(sourceTokens[i]);\n      if (sourceTokens[i][2].length > 0 && uniqueTokensWithBody.indexOf(sourceTokens[i]) == -1) uniqueTokensWithBody.push(sourceTokens[i]);\n    }\n\n    return uniqueTokensWithBody.length > 1 ? mergeableTokens : [];\n  }\n\n  function shortenIfPossible(position, movedProperty) {\n    var name = movedProperty[0];\n    var value = movedProperty[1];\n    var key = movedProperty[4];\n    var valueSize = name.length + value.length + 1;\n    var allSelectors = [];\n    var qualifiedTokens = [];\n    var mergeableTokens = tokensToMerge(movableTokens[key]);\n    if (mergeableTokens.length < 2) return;\n    var allFits = findAllFits(mergeableTokens, valueSize, 1);\n    var bestFit = allFits[0];\n    if (bestFit[1] > 0) return sendToMultiPropertyMoveCache(position, movedProperty, allFits);\n\n    for (var i = bestFit[0].length - 1; i >= 0; i--) {\n      allSelectors = bestFit[0][i][1].concat(allSelectors);\n      qualifiedTokens.unshift(bestFit[0][i]);\n    }\n\n    allSelectors = tidyRuleDuplicates(allSelectors);\n    dropAsNewTokenAt(position, [movedProperty], allSelectors, qualifiedTokens);\n  }\n\n  function fitSorter(fit1, fit2) {\n    return fit1[1] > fit2[1] ? 1 : fit1[1] == fit2[1] ? 0 : -1;\n  }\n\n  function findAllFits(mergeableTokens, propertySize, propertiesCount) {\n    var combinations = allCombinations(mergeableTokens, propertySize, propertiesCount, maxCombinationsLevel - 1);\n    return combinations.sort(fitSorter);\n  }\n\n  function allCombinations(tokensVariant, propertySize, propertiesCount, level) {\n    var differenceVariants = [[tokensVariant, sizeDifference(tokensVariant, propertySize, propertiesCount)]];\n\n    if (tokensVariant.length > 2 && level > 0) {\n      for (var i = tokensVariant.length - 1; i >= 0; i--) {\n        var subVariant = Array.prototype.slice.call(tokensVariant, 0);\n        subVariant.splice(i, 1);\n        differenceVariants = differenceVariants.concat(allCombinations(subVariant, propertySize, propertiesCount, level - 1));\n      }\n    }\n\n    return differenceVariants;\n  }\n\n  function sizeDifference(tokensVariant, propertySize, propertiesCount) {\n    var allSelectorsSize = 0;\n\n    for (var i = tokensVariant.length - 1; i >= 0; i--) {\n      allSelectorsSize += tokensVariant[i][2].length > propertiesCount ? serializeRules(tokensVariant[i][1]).length : -1;\n    }\n\n    return allSelectorsSize - (tokensVariant.length - 1) * propertySize + 1;\n  }\n\n  function dropAsNewTokenAt(position, properties, allSelectors, mergeableTokens) {\n    var i, j, k, m;\n    var allProperties = [];\n\n    for (i = mergeableTokens.length - 1; i >= 0; i--) {\n      var mergeableToken = mergeableTokens[i];\n\n      for (j = mergeableToken[2].length - 1; j >= 0; j--) {\n        var mergeableProperty = mergeableToken[2][j];\n\n        for (k = 0, m = properties.length; k < m; k++) {\n          var property = properties[k];\n          var mergeablePropertyName = mergeableProperty[1][1];\n          var propertyName = property[0];\n          var propertyBody = property[4];\n\n          if (mergeablePropertyName == propertyName && serializeBody([mergeableProperty]) == propertyBody) {\n            mergeableToken[2].splice(j, 1);\n            break;\n          }\n        }\n      }\n    }\n\n    for (i = properties.length - 1; i >= 0; i--) {\n      allProperties.unshift(properties[i][3]);\n    }\n\n    var newToken = [Token.RULE, allSelectors, allProperties];\n    tokens.splice(position, 0, newToken);\n  }\n\n  function dropPropertiesAt(position, movedProperty) {\n    var key = movedProperty[4];\n    var toMove = movableTokens[key];\n\n    if (toMove && toMove.length > 1) {\n      if (!shortenMultiMovesIfPossible(position, movedProperty)) shortenIfPossible(position, movedProperty);\n    }\n  }\n\n  function shortenMultiMovesIfPossible(position, movedProperty) {\n    var candidates = [];\n    var propertiesAndMergableTokens = [];\n    var key = movedProperty[4];\n    var j, k;\n    var mergeableTokens = tokensToMerge(movableTokens[key]);\n    if (mergeableTokens.length < 2) return;\n\n    movableLoop: for (var value in movableTokens) {\n      var tokensList = movableTokens[value];\n\n      for (j = mergeableTokens.length - 1; j >= 0; j--) {\n        if (tokensList.indexOf(mergeableTokens[j]) == -1) continue movableLoop;\n      }\n\n      candidates.push(value);\n    }\n\n    if (candidates.length < 2) return false;\n\n    for (j = candidates.length - 1; j >= 0; j--) {\n      for (k = movedProperties.length - 1; k >= 0; k--) {\n        if (movedProperties[k][4] == candidates[j]) {\n          propertiesAndMergableTokens.unshift([movedProperties[k], mergeableTokens]);\n          break;\n        }\n      }\n    }\n\n    return processMultiPropertyMove(position, propertiesAndMergableTokens);\n  }\n\n  function processMultiPropertyMove(position, propertiesAndMergableTokens) {\n    var valueSize = 0;\n    var properties = [];\n    var property;\n\n    for (var i = propertiesAndMergableTokens.length - 1; i >= 0; i--) {\n      property = propertiesAndMergableTokens[i][0];\n      var fullValue = property[4];\n      valueSize += fullValue.length + (i > 0 ? 1 : 0);\n      properties.push(property);\n    }\n\n    var mergeableTokens = propertiesAndMergableTokens[0][1];\n    var bestFit = findAllFits(mergeableTokens, valueSize, properties.length)[0];\n    if (bestFit[1] > 0) return false;\n    var allSelectors = [];\n    var qualifiedTokens = [];\n\n    for (i = bestFit[0].length - 1; i >= 0; i--) {\n      allSelectors = bestFit[0][i][1].concat(allSelectors);\n      qualifiedTokens.unshift(bestFit[0][i]);\n    }\n\n    allSelectors = tidyRuleDuplicates(allSelectors);\n    dropAsNewTokenAt(position, properties, allSelectors, qualifiedTokens);\n\n    for (i = properties.length - 1; i >= 0; i--) {\n      property = properties[i];\n      var index = movedProperties.indexOf(property);\n      delete movableTokens[property[4]];\n      if (index > -1 && movedToBeDropped.indexOf(index) == -1) movedToBeDropped.push(index);\n    }\n\n    return true;\n  }\n\n  function boundToAnotherPropertyInCurrrentToken(property, movedProperty, token) {\n    var propertyName = property[0];\n    var movedPropertyName = movedProperty[0];\n    if (propertyName != movedPropertyName) return false;\n    var key = movedProperty[4];\n    var toMove = movableTokens[key];\n    return toMove && toMove.indexOf(token) > -1;\n  }\n\n  for (var i = tokens.length - 1; i >= 0; i--) {\n    var token = tokens[i];\n    var isRule;\n    var j, k, m;\n    var samePropertyAt;\n\n    if (token[0] == Token.RULE) {\n      isRule = true;\n    } else if (token[0] == Token.NESTED_BLOCK) {\n      isRule = false;\n    } else {\n      continue;\n    } // We cache movedProperties.length as it may change in the loop\n\n\n    var movedCount = movedProperties.length;\n    var properties = extractProperties(token);\n    movedToBeDropped = [];\n    var unmovableInCurrentToken = [];\n\n    for (j = properties.length - 1; j >= 0; j--) {\n      for (k = j - 1; k >= 0; k--) {\n        if (!canReorderSingle(properties[j], properties[k], specificityCache)) {\n          unmovableInCurrentToken.push(j);\n          break;\n        }\n      }\n    }\n\n    for (j = properties.length - 1; j >= 0; j--) {\n      var property = properties[j];\n      var movedSameProperty = false;\n\n      for (k = 0; k < movedCount; k++) {\n        var movedProperty = movedProperties[k];\n\n        if (movedToBeDropped.indexOf(k) == -1 && (!canReorderSingle(property, movedProperty, specificityCache) && !boundToAnotherPropertyInCurrrentToken(property, movedProperty, token) || movableTokens[movedProperty[4]] && movableTokens[movedProperty[4]].length === mergeLimit)) {\n          dropPropertiesAt(i + 1, movedProperty, token);\n\n          if (movedToBeDropped.indexOf(k) == -1) {\n            movedToBeDropped.push(k);\n            delete movableTokens[movedProperty[4]];\n          }\n        }\n\n        if (!movedSameProperty) {\n          movedSameProperty = property[0] == movedProperty[0] && property[1] == movedProperty[1];\n\n          if (movedSameProperty) {\n            samePropertyAt = k;\n          }\n        }\n      }\n\n      if (!isRule || unmovableInCurrentToken.indexOf(j) > -1) continue;\n      var key = property[4];\n\n      if (movedSameProperty && movedProperties[samePropertyAt][5].length + property[5].length > mergeLimit) {\n        dropPropertiesAt(i + 1, movedProperties[samePropertyAt]);\n        movedProperties.splice(samePropertyAt, 1);\n        movableTokens[key] = [token];\n        movedSameProperty = false;\n      } else {\n        movableTokens[key] = movableTokens[key] || [];\n        movableTokens[key].push(token);\n      }\n\n      if (movedSameProperty) {\n        movedProperties[samePropertyAt] = cloneAndMergeSelectors(movedProperties[samePropertyAt], property);\n      } else {\n        movedProperties.push(property);\n      }\n    }\n\n    movedToBeDropped = movedToBeDropped.sort(naturalSorter);\n\n    for (j = 0, m = movedToBeDropped.length; j < m; j++) {\n      var dropAt = movedToBeDropped[j] - j;\n      movedProperties.splice(dropAt, 1);\n    }\n  }\n\n  var position = tokens[0] && tokens[0][0] == Token.AT_RULE && tokens[0][1].indexOf('@charset') === 0 ? 1 : 0;\n\n  for (; position < tokens.length - 1; position++) {\n    var isImportRule = tokens[position][0] === Token.AT_RULE && tokens[position][1].indexOf('@import') === 0;\n    var isComment = tokens[position][0] === Token.COMMENT;\n    if (!(isImportRule || isComment)) break;\n  }\n\n  for (i = 0; i < movedProperties.length; i++) {\n    dropPropertiesAt(position, movedProperties[i]);\n  }\n}\n\nmodule.exports = restructure;","map":{"version":3,"sources":["/Users/nguyenquytoan/Desktop/PTUDW-17TN-Nhom05-USFL/react-usfl/PTUDW-17TN-Nhom05/node_modules/clean-css/lib/optimizer/level-2/restructure.js"],"names":["canReorderSingle","require","extractProperties","isMergeable","tidyRuleDuplicates","Token","cloneArray","serializeBody","body","serializeRules","rules","naturalSorter","a","b","cloneAndMergeSelectors","propertyA","propertyB","cloned","concat","restructure","tokens","context","options","mergeablePseudoClasses","compatibility","selectors","mergeablePseudoElements","mergeLimit","multiplePseudoMerging","specificityCache","cache","specificity","movableTokens","movedProperties","multiPropertyMoveCache","movedToBeDropped","maxCombinationsLevel","ID_JOIN_CHARACTER","sendToMultiPropertyMoveCache","position","movedProperty","allFits","i","length","fit","id","addToCache","processMultiPropertyMove","removeAllMatchingFromCache","cacheId","push","matchId","matchSelectors","split","forRemoval","indexOf","cachedTokens","l","join","tokensToMerge","sourceTokens","uniqueTokensWithBody","mergeableTokens","unshift","shortenIfPossible","name","value","key","valueSize","allSelectors","qualifiedTokens","findAllFits","bestFit","dropAsNewTokenAt","fitSorter","fit1","fit2","propertySize","propertiesCount","combinations","allCombinations","sort","tokensVariant","level","differenceVariants","sizeDifference","subVariant","Array","prototype","slice","call","splice","allSelectorsSize","properties","j","k","m","allProperties","mergeableToken","mergeableProperty","property","mergeablePropertyName","propertyName","propertyBody","newToken","RULE","dropPropertiesAt","toMove","shortenMultiMovesIfPossible","candidates","propertiesAndMergableTokens","movableLoop","tokensList","fullValue","index","boundToAnotherPropertyInCurrrentToken","token","movedPropertyName","isRule","samePropertyAt","NESTED_BLOCK","movedCount","unmovableInCurrentToken","movedSameProperty","dropAt","AT_RULE","isImportRule","isComment","COMMENT","module","exports"],"mappings":"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","sourcesContent":["var canReorderSingle = require('./reorderable').canReorderSingle;\nvar extractProperties = require('./extract-properties');\nvar isMergeable = require('./is-mergeable');\nvar tidyRuleDuplicates = require('./tidy-rule-duplicates');\n\nvar Token = require('../../tokenizer/token');\n\nvar cloneArray = require('../../utils/clone-array');\n\nvar serializeBody = require('../../writer/one-time').body;\nvar serializeRules = require('../../writer/one-time').rules;\n\nfunction naturalSorter(a, b) {\n  return a > b ? 1 : -1;\n}\n\nfunction cloneAndMergeSelectors(propertyA, propertyB) {\n  var cloned = cloneArray(propertyA);\n  cloned[5] = cloned[5].concat(propertyB[5]);\n\n  return cloned;\n}\n\nfunction restructure(tokens, context) {\n  var options = context.options;\n  var mergeablePseudoClasses = options.compatibility.selectors.mergeablePseudoClasses;\n  var mergeablePseudoElements = options.compatibility.selectors.mergeablePseudoElements;\n  var mergeLimit = options.compatibility.selectors.mergeLimit;\n  var multiplePseudoMerging = options.compatibility.selectors.multiplePseudoMerging;\n  var specificityCache = context.cache.specificity;\n  var movableTokens = {};\n  var movedProperties = [];\n  var multiPropertyMoveCache = {};\n  var movedToBeDropped = [];\n  var maxCombinationsLevel = 2;\n  var ID_JOIN_CHARACTER = '%';\n\n  function sendToMultiPropertyMoveCache(position, movedProperty, allFits) {\n    for (var i = allFits.length - 1; i >= 0; i--) {\n      var fit = allFits[i][0];\n      var id = addToCache(movedProperty, fit);\n\n      if (multiPropertyMoveCache[id].length > 1 && processMultiPropertyMove(position, multiPropertyMoveCache[id])) {\n        removeAllMatchingFromCache(id);\n        break;\n      }\n    }\n  }\n\n  function addToCache(movedProperty, fit) {\n    var id = cacheId(fit);\n    multiPropertyMoveCache[id] = multiPropertyMoveCache[id] || [];\n    multiPropertyMoveCache[id].push([movedProperty, fit]);\n    return id;\n  }\n\n  function removeAllMatchingFromCache(matchId) {\n    var matchSelectors = matchId.split(ID_JOIN_CHARACTER);\n    var forRemoval = [];\n    var i;\n\n    for (var id in multiPropertyMoveCache) {\n      var selectors = id.split(ID_JOIN_CHARACTER);\n      for (i = selectors.length - 1; i >= 0; i--) {\n        if (matchSelectors.indexOf(selectors[i]) > -1) {\n          forRemoval.push(id);\n          break;\n        }\n      }\n    }\n\n    for (i = forRemoval.length - 1; i >= 0; i--) {\n      delete multiPropertyMoveCache[forRemoval[i]];\n    }\n  }\n\n  function cacheId(cachedTokens) {\n    var id = [];\n    for (var i = 0, l = cachedTokens.length; i < l; i++) {\n      id.push(serializeRules(cachedTokens[i][1]));\n    }\n    return id.join(ID_JOIN_CHARACTER);\n  }\n\n  function tokensToMerge(sourceTokens) {\n    var uniqueTokensWithBody = [];\n    var mergeableTokens = [];\n\n    for (var i = sourceTokens.length - 1; i >= 0; i--) {\n      if (!isMergeable(serializeRules(sourceTokens[i][1]), mergeablePseudoClasses, mergeablePseudoElements, multiplePseudoMerging)) {\n        continue;\n      }\n\n      mergeableTokens.unshift(sourceTokens[i]);\n      if (sourceTokens[i][2].length > 0 && uniqueTokensWithBody.indexOf(sourceTokens[i]) == -1)\n        uniqueTokensWithBody.push(sourceTokens[i]);\n    }\n\n    return uniqueTokensWithBody.length > 1 ?\n      mergeableTokens :\n      [];\n  }\n\n  function shortenIfPossible(position, movedProperty) {\n    var name = movedProperty[0];\n    var value = movedProperty[1];\n    var key = movedProperty[4];\n    var valueSize = name.length + value.length + 1;\n    var allSelectors = [];\n    var qualifiedTokens = [];\n\n    var mergeableTokens = tokensToMerge(movableTokens[key]);\n    if (mergeableTokens.length < 2)\n      return;\n\n    var allFits = findAllFits(mergeableTokens, valueSize, 1);\n    var bestFit = allFits[0];\n    if (bestFit[1] > 0)\n      return sendToMultiPropertyMoveCache(position, movedProperty, allFits);\n\n    for (var i = bestFit[0].length - 1; i >=0; i--) {\n      allSelectors = bestFit[0][i][1].concat(allSelectors);\n      qualifiedTokens.unshift(bestFit[0][i]);\n    }\n\n    allSelectors = tidyRuleDuplicates(allSelectors);\n    dropAsNewTokenAt(position, [movedProperty], allSelectors, qualifiedTokens);\n  }\n\n  function fitSorter(fit1, fit2) {\n    return fit1[1] > fit2[1] ? 1 : (fit1[1] == fit2[1] ? 0 : -1);\n  }\n\n  function findAllFits(mergeableTokens, propertySize, propertiesCount) {\n    var combinations = allCombinations(mergeableTokens, propertySize, propertiesCount, maxCombinationsLevel - 1);\n    return combinations.sort(fitSorter);\n  }\n\n  function allCombinations(tokensVariant, propertySize, propertiesCount, level) {\n    var differenceVariants = [[tokensVariant, sizeDifference(tokensVariant, propertySize, propertiesCount)]];\n    if (tokensVariant.length > 2 && level > 0) {\n      for (var i = tokensVariant.length - 1; i >= 0; i--) {\n        var subVariant = Array.prototype.slice.call(tokensVariant, 0);\n        subVariant.splice(i, 1);\n        differenceVariants = differenceVariants.concat(allCombinations(subVariant, propertySize, propertiesCount, level - 1));\n      }\n    }\n\n    return differenceVariants;\n  }\n\n  function sizeDifference(tokensVariant, propertySize, propertiesCount) {\n    var allSelectorsSize = 0;\n    for (var i = tokensVariant.length - 1; i >= 0; i--) {\n      allSelectorsSize += tokensVariant[i][2].length > propertiesCount ? serializeRules(tokensVariant[i][1]).length : -1;\n    }\n    return allSelectorsSize - (tokensVariant.length - 1) * propertySize + 1;\n  }\n\n  function dropAsNewTokenAt(position, properties, allSelectors, mergeableTokens) {\n    var i, j, k, m;\n    var allProperties = [];\n\n    for (i = mergeableTokens.length - 1; i >= 0; i--) {\n      var mergeableToken = mergeableTokens[i];\n\n      for (j = mergeableToken[2].length - 1; j >= 0; j--) {\n        var mergeableProperty = mergeableToken[2][j];\n\n        for (k = 0, m = properties.length; k < m; k++) {\n          var property = properties[k];\n\n          var mergeablePropertyName = mergeableProperty[1][1];\n          var propertyName = property[0];\n          var propertyBody = property[4];\n          if (mergeablePropertyName == propertyName && serializeBody([mergeableProperty]) == propertyBody) {\n            mergeableToken[2].splice(j, 1);\n            break;\n          }\n        }\n      }\n    }\n\n    for (i = properties.length - 1; i >= 0; i--) {\n      allProperties.unshift(properties[i][3]);\n    }\n\n    var newToken = [Token.RULE, allSelectors, allProperties];\n    tokens.splice(position, 0, newToken);\n  }\n\n  function dropPropertiesAt(position, movedProperty) {\n    var key = movedProperty[4];\n    var toMove = movableTokens[key];\n\n    if (toMove && toMove.length > 1) {\n      if (!shortenMultiMovesIfPossible(position, movedProperty))\n        shortenIfPossible(position, movedProperty);\n    }\n  }\n\n  function shortenMultiMovesIfPossible(position, movedProperty) {\n    var candidates = [];\n    var propertiesAndMergableTokens = [];\n    var key = movedProperty[4];\n    var j, k;\n\n    var mergeableTokens = tokensToMerge(movableTokens[key]);\n    if (mergeableTokens.length < 2)\n      return;\n\n    movableLoop:\n    for (var value in movableTokens) {\n      var tokensList = movableTokens[value];\n\n      for (j = mergeableTokens.length - 1; j >= 0; j--) {\n        if (tokensList.indexOf(mergeableTokens[j]) == -1)\n          continue movableLoop;\n      }\n\n      candidates.push(value);\n    }\n\n    if (candidates.length < 2)\n      return false;\n\n    for (j = candidates.length - 1; j >= 0; j--) {\n      for (k = movedProperties.length - 1; k >= 0; k--) {\n        if (movedProperties[k][4] == candidates[j]) {\n          propertiesAndMergableTokens.unshift([movedProperties[k], mergeableTokens]);\n          break;\n        }\n      }\n    }\n\n    return processMultiPropertyMove(position, propertiesAndMergableTokens);\n  }\n\n  function processMultiPropertyMove(position, propertiesAndMergableTokens) {\n    var valueSize = 0;\n    var properties = [];\n    var property;\n\n    for (var i = propertiesAndMergableTokens.length - 1; i >= 0; i--) {\n      property = propertiesAndMergableTokens[i][0];\n      var fullValue = property[4];\n      valueSize += fullValue.length + (i > 0 ? 1 : 0);\n\n      properties.push(property);\n    }\n\n    var mergeableTokens = propertiesAndMergableTokens[0][1];\n    var bestFit = findAllFits(mergeableTokens, valueSize, properties.length)[0];\n    if (bestFit[1] > 0)\n      return false;\n\n    var allSelectors = [];\n    var qualifiedTokens = [];\n    for (i = bestFit[0].length - 1; i >= 0; i--) {\n      allSelectors = bestFit[0][i][1].concat(allSelectors);\n      qualifiedTokens.unshift(bestFit[0][i]);\n    }\n\n    allSelectors = tidyRuleDuplicates(allSelectors);\n    dropAsNewTokenAt(position, properties, allSelectors, qualifiedTokens);\n\n    for (i = properties.length - 1; i >= 0; i--) {\n      property = properties[i];\n      var index = movedProperties.indexOf(property);\n\n      delete movableTokens[property[4]];\n\n      if (index > -1 && movedToBeDropped.indexOf(index) == -1)\n        movedToBeDropped.push(index);\n    }\n\n    return true;\n  }\n\n  function boundToAnotherPropertyInCurrrentToken(property, movedProperty, token) {\n    var propertyName = property[0];\n    var movedPropertyName = movedProperty[0];\n    if (propertyName != movedPropertyName)\n      return false;\n\n    var key = movedProperty[4];\n    var toMove = movableTokens[key];\n    return toMove && toMove.indexOf(token) > -1;\n  }\n\n  for (var i = tokens.length - 1; i >= 0; i--) {\n    var token = tokens[i];\n    var isRule;\n    var j, k, m;\n    var samePropertyAt;\n\n    if (token[0] == Token.RULE) {\n      isRule = true;\n    } else if (token[0] == Token.NESTED_BLOCK) {\n      isRule = false;\n    } else {\n      continue;\n    }\n\n    // We cache movedProperties.length as it may change in the loop\n    var movedCount = movedProperties.length;\n\n    var properties = extractProperties(token);\n    movedToBeDropped = [];\n\n    var unmovableInCurrentToken = [];\n    for (j = properties.length - 1; j >= 0; j--) {\n      for (k = j - 1; k >= 0; k--) {\n        if (!canReorderSingle(properties[j], properties[k], specificityCache)) {\n          unmovableInCurrentToken.push(j);\n          break;\n        }\n      }\n    }\n\n    for (j = properties.length - 1; j >= 0; j--) {\n      var property = properties[j];\n      var movedSameProperty = false;\n\n      for (k = 0; k < movedCount; k++) {\n        var movedProperty = movedProperties[k];\n\n        if (movedToBeDropped.indexOf(k) == -1 && (!canReorderSingle(property, movedProperty, specificityCache) && !boundToAnotherPropertyInCurrrentToken(property, movedProperty, token) ||\n            movableTokens[movedProperty[4]] && movableTokens[movedProperty[4]].length === mergeLimit)) {\n          dropPropertiesAt(i + 1, movedProperty, token);\n\n          if (movedToBeDropped.indexOf(k) == -1) {\n            movedToBeDropped.push(k);\n            delete movableTokens[movedProperty[4]];\n          }\n        }\n\n        if (!movedSameProperty) {\n          movedSameProperty = property[0] == movedProperty[0] && property[1] == movedProperty[1];\n\n          if (movedSameProperty) {\n            samePropertyAt = k;\n          }\n        }\n      }\n\n      if (!isRule || unmovableInCurrentToken.indexOf(j) > -1)\n        continue;\n\n      var key = property[4];\n\n      if (movedSameProperty && movedProperties[samePropertyAt][5].length + property[5].length > mergeLimit) {\n        dropPropertiesAt(i + 1, movedProperties[samePropertyAt]);\n        movedProperties.splice(samePropertyAt, 1);\n        movableTokens[key] = [token];\n        movedSameProperty = false;\n      } else {\n        movableTokens[key] = movableTokens[key] || [];\n        movableTokens[key].push(token);\n      }\n\n      if (movedSameProperty) {\n        movedProperties[samePropertyAt] = cloneAndMergeSelectors(movedProperties[samePropertyAt], property);\n      } else {\n        movedProperties.push(property);\n      }\n    }\n\n    movedToBeDropped = movedToBeDropped.sort(naturalSorter);\n    for (j = 0, m = movedToBeDropped.length; j < m; j++) {\n      var dropAt = movedToBeDropped[j] - j;\n      movedProperties.splice(dropAt, 1);\n    }\n  }\n\n  var position = tokens[0] && tokens[0][0] == Token.AT_RULE && tokens[0][1].indexOf('@charset') === 0 ? 1 : 0;\n  for (; position < tokens.length - 1; position++) {\n    var isImportRule = tokens[position][0] === Token.AT_RULE && tokens[position][1].indexOf('@import') === 0;\n    var isComment = tokens[position][0] === Token.COMMENT;\n    if (!(isImportRule || isComment))\n      break;\n  }\n\n  for (i = 0; i < movedProperties.length; i++) {\n    dropPropertiesAt(position, movedProperties[i]);\n  }\n}\n\nmodule.exports = restructure;\n"]},"metadata":{},"sourceType":"script"}